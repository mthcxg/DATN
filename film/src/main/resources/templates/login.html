<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{admin/fragments/head :: head}"></head>
<link type="text/css" rel="stylesheet" th:href="@{/assets/css/user.css}" />
<link type="text/css" rel="stylesheet" th:href="@{/assets/css/auth.css}" />
<link href='https://fonts.googleapis.com/css?family=Wendy One' rel='stylesheet'>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css">
<div th:replace="user/fragments/header-guest :: header-guest"></div>

<body
	th:style="'background-image:url(' + @{/assets/images/bg.png} + '); background-repeat: no-repeat, repeat; background-size: cover;'"
	style="background-image:url('assets/images/bg.png'); background-repeat: no-repeat, repeat; background-size: cover;">
	<div class="login-content">
		<div class="login-form">
			<p>Log In</p>

			<form action="/login" method="POST" id="loginForm">
				<input type="text" placeholder="Email" name="email" th:value="*{email}">
				<div style="position: relative;">
					<input type="password" placeholder="Password" id="password-input" name="password"
						style="padding-right: 30px; color: black">
					<i class="fas fa-eye-slash" id="password-toggle"
						style="position: absolute; top: 50%; right: 10px; transform: translateY(-50%); cursor: pointer;color: black;"></i>
				</div>

				<!-- Hiển thị thông báo lỗi nếu có -->
				<div th:if="${errorMessage}" style="color: red; margin-top: 10px;">
					<p style="margin-top: 10px; font-family: 'Wendy One', sans-serif; font-size: 18px;"
						th:text="${errorMessage}"></p>
				</div>

				<a href="javascript:void(0)" id="forgotPasswordLink"
					style="color: red;margin-top: 10px; font-family: 'Wendy One', sans-serif; font-size: 18px;">Forget
					Password?</a>
				<button class="forget-button" type="submit">Log In</button>
			</form>

			<!-- Form nhập email để gửi OTP -->
			<div id="emailForm" style="display: none;">
				<input type="email" id="email-input" placeholder="Enter your email">
				<button class="forget-button" id="sendOtpButton">Send OTP</button>
				<p id="emailError" style="color: red; display: none;"></p>
			</div>

			<!-- Form nhập OTP -->
			<div id="otpForm" style="display:none;">
				<div class="input-field">
					<input type="text" maxlength="1">
					<input type="text" maxlength="1" disabled>
					<input type="text" maxlength="1" disabled>
					<input type="text" maxlength="1" disabled>
					<input type="text" maxlength="1" disabled>
					<input type="text" maxlength="1" disabled>
				</div>
				<button class="forget-button" id="verifyOtpButton" disabled>Verify OTP</button>
			</div>

			<!-- Form nhập mật khẩu mới -->
			<div id="resetPasswordForm" style="display:none;">
				<input type="password" id="newPassword" placeholder="New Password">
				<input type="password" id="confirmPassword" placeholder="Confirm Password">
				<div id="passwordError" style="display:none; color:red;"></div>
				<button class ="forget-button" id="updatePasswordButton">Update Password</button>
			</div>

			<p style="margin-top: 10px; font-family: 'Wendy One', sans-serif; font-size: 18px;">
				Don't have an account?
				<a href="/register" style="color: red; text-decoration: none;">Register</a>
			</p>
		</div>
	</div>

	<script>
		// Toggle password visibility
		function togglePasswordVisibility(inputId, toggleId) {
			var input = document.querySelector('#' + inputId);
			var toggle = document.querySelector('#' + toggleId);

			if (input.type === 'password') {
				input.type = 'text';
				toggle.classList.remove('fa-eye-slash');
				toggle.classList.add('fa-eye');
			} else {
				input.type = 'password';
				toggle.classList.remove('fa-eye');
				toggle.classList.add('fa-eye-slash');
			}
		}

		// Add event listener
		var passwordToggle = document.querySelector('#password-toggle');
		passwordToggle.addEventListener('click', function () {
			togglePasswordVisibility('password-input', 'password-toggle');
		});

		// Chuyển đổi giữa các form khi nhấn vào "Forget Password?"
		document.getElementById('forgotPasswordLink').addEventListener('click', function () {
			document.getElementById('loginForm').style.display = 'none';
			document.getElementById('emailForm').style.display = 'block';
		});

		async function sendOtp(email) {
			try {
				const response = await fetch('/user/send-otp', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/x-www-form-urlencoded'
					},
					body: new URLSearchParams({email: email})
				});

				if (!response.ok) {
					throw new Error('Network response was not ok');
				}

				const responseData = await response.json();
				console.log('Response from server:', responseData);
				return responseData;
			} catch (error) {
				console.error('Error occurred during fetch operation:', error);
				return {success: false, message: 'Failed to send OTP. Please try again.'};
			}
		}

		// JavaScript
		document.getElementById('sendOtpButton').addEventListener('click', async function () {
			const email = document.getElementById('email-input').value;
			if (email === '') {
				alert('Please enter your email.');
				return;
			}

			const response = await sendOtp(email);
			if (response.success) {
				alert('OTP sent to your email.');

				// Hide email form and show OTP form
				document.getElementById('emailForm').style.display = 'none';
				document.getElementById('otpForm').style.display = 'block';
			} else {
				alert(response.message);
			}
		});

		const otpInputs = document.querySelectorAll(".input-field input"),
			otpButton = document.querySelector("#verifyOtpButton");

		otpInputs.forEach((input, index) => {
			input.addEventListener("keyup", function (e) {
				const currentInput = input, nextInput = input.nextElementSibling, prevInput = input.previousElementSibling;

				if (currentInput.value.length > 1) {
					currentInput.value = "";
					return;
				}

				if (nextInput && nextInput.hasAttribute("disabled") && currentInput.value !== "") {
					nextInput.removeAttribute("disabled");
					nextInput.focus();
				}

				if (e.key === "Backspace") {
					otpInputs.forEach((input, idx) => {
						if (index <= idx && prevInput) {
							input.setAttribute("disabled", true);
							input.value = "";
							prevInput.focus();
						}
					});
				}

				if (!otpInputs[5].disabled && otpInputs[5].value !== "") {
					otpButton.classList.add("active");
					otpButton.removeAttribute("disabled");
					return;
				}
				otpButton.classList.remove("active");
				otpButton.setAttribute("disabled", true);
			});
		});

		otpButton.addEventListener("click", async function () {
			let enteredOtp = "";
			otpInputs.forEach(input => {
				enteredOtp += input.value;
			});

			const response = await verifyOtp(enteredOtp);
			if (response.success) {
				alert("OTP verified successfully!");

				// Hide OTP form and show reset password form
				document.getElementById('otpForm').style.display = 'none';
				document.getElementById('resetPasswordForm').style.display = 'block';
			} else {
				alert(response.message);
			}
		});

		async function verifyOtp(otp) {
			try {
				const response = await fetch('/user/verify-otp', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/x-www-form-urlencoded'
					},
					body: new URLSearchParams({otp: otp})
				});

				if (!response.ok) {
					throw new Error('Network response was not ok');
				}

				const responseData = await response.json();
				console.log('Response from server:', responseData);
				return responseData;
			} catch (error) {
				console.error('Error occurred during fetch operation:', error);
				return {success: false, message: 'Failed to verify OTP. Please try again.'};
			}
		}

		document.getElementById('updatePasswordButton').addEventListener('click', async function () {
			const newPassword = document.getElementById('newPassword').value;
			const confirmPassword = document.getElementById('confirmPassword').value;

			if (newPassword === '' || confirmPassword === '') {
				alert('Please fill in both password fields.');
				return;
			}

			if (newPassword !== confirmPassword) {
				document.getElementById('passwordError').textContent = 'Passwords do not match.';
				document.getElementById('passwordError').style.display = 'block';
				return;
			}

			try {
				const email = document.getElementById('email-input').value; // Lấy email từ trường email ban đầu
				const response = await resetPassword(email, newPassword);

				if (!response.success) {
					throw new Error(response.message);
				}

				alert('Password updated successfully!');

				// Reset các form về trạng thái ban đầu
				document.getElementById('resetPasswordForm').style.display = 'none';
				document.getElementById('loginForm').style.display = 'block';
			} catch (error) {
				console.error('There was a problem with the fetch operation:', error);
				alert('Failed to update password. Please try again.');
			}
		});

		async function resetPassword(email, newPassword) {
			try {
				const response = await fetch('/user/reset-password', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/x-www-form-urlencoded'
					},
					body: new URLSearchParams({
						email: email,
						newPassword: newPassword
					})
				});

				if (!response.ok) {
					throw new Error('Network response was not ok');
				}

				const responseData = await response.json();
				console.log('Response from server:', responseData);
				return responseData;
			} catch (error) {
				console.error('Error occurred during fetch operation:', error);
				return {success: false, message: 'Failed to reset password. Please try again.'};
			}
		}
	</script>
	<style>
		.input-field {
			display: flex;
			flex-wrap: wrap;
			justify-content: center;
		}

		.input-field input {
			width: 40px;
			height: 40px;
			margin-right: 5px;
			text-align: center;
			font-size: 20px;
			border: 1px solid #ccc;
			border-radius: 5px;
		}
	</style>
</body>

</html>