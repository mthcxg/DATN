<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{admin/fragments/head :: head}"></head>
<link type="text/css" rel="stylesheet" th:href="@{/assets/css/user.css}" />
<link type="text/css" rel="stylesheet" th:href="@{/assets/css/auth.css}" />
<link href='https://fonts.googleapis.com/css?family=Wendy One' rel='stylesheet'>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css">
<div th:replace="user/fragments/header-guest :: header-guest"></div>

<head>
	<style>
		.product_image {
			display: flex;
			justify-content: center;
			align-items: center;
			margin-bottom: 20px;
		}

		.product_image img {
			max-width: 100%;
			max-height: 100%;
		}

		.product_details {
			margin-left: 30px;
		}

		.product_name {
			font-size: 100px;
			font-weight: bold;
			color: #2435f5;
		}


		.product_description {
			margin-top: 10px;
			font-size: 20px;
			color: #333;
			font-family: 'lato';
			color: #ffffff;
		}

		.certificate-box {
			display: inline-block;
			background-color: #FF3131;
			color: #ffffff;
			padding: 8px 12px;
			font-size: 20px;
			border-radius: 4px;
			margin-left: 10px;
			vertical-align: middle;
		}

		.comment-container {
			border: 1px solid #ccc;
			padding: 10px;
			margin-bottom: 10px;
			display: flex;
		}

		.avatar {
			width: 50px;
			height: 50px;
			border-radius: 50%;
			object-fit: cover;
			margin-right: 10px;
		}

		.username {
			font-family: 'Wendy One', sans-serif;
			font-size: 18px;
		}

		.rating {
			color: #FF3131;
			margin-bottom: 5px;
			font-size: 15px;
		}

		.star-empty {
			color: #ccc;
		}

		.comment-text {
			margin: 0;
			font-size: 18px;
		}

		h2+.content-container {
			margin-top: 0;
		}
	</style>
</head>

<body style="background-color: #212121; z-index: 1;">

	<div class="content-container">
		<div class="row">
			<div class="col-lg-6">
				<div class="image-container">
					<img th:src="${movie.image}" alt="Movie Image" class="image" />
				</div>
			</div>
			<div class="col-lg-6">
				<h1 style="font-family: 'Wendy One', sans-serif;color: #ffffff; font-size: 50px;">[(${movie.name})]
					<div class="certificate-box">
						[(${movie.certificate})]
					</div>
				</h1>
				<div class="product_description">
					<span style="font-weight: bold;">Metasccore: </span><span
						style="color: #FF3131">[(${movie.metascore})]</span><br>
					<span style="font-weight: bold;">Rating: </span> <span id="starRating"></span> <span
						style="color: #FF3131">[(${movie.rate})] </span> Voted by
					[(${movie.num_rate})] peoples<br>
					<span style="font-weight: bold;">Description:</span> [(${movie.description})]
					<ul style="list-style-type: none; padding: 0;">
						<li th:each="category : ${categories}"
							style="display: inline-block; padding: 5px 10px; border: 1px solid white; border-radius: 10px; margin-right: 8px; margin-top: 8px;">
							<a th:href="@{/categories/{categoryId}/movies(categoryId=${category.id})}"
								th:text="${category.name}" style="color: inherit; text-decoration: none;"></a>
						</li>
					</ul>
					<button id="addToFavoriteBtn" th:attr="data-movie-id=${movie.id}"
						style="font-family: 'Wendy One', sans-serif; background-color: #FF3131; color: #000000; padding: 10px 20px; border: none; border-radius: 5px; margin-top: 10px;">
						+ Add to favorite
					</button>
				</div>
			</div>
		</div>
		<br>
		<br>
		<div style=" display: flex; align-items: center;">
			<h1 style="font-family: 'Wendy One', sans-serif;"> Director</h1>
			<a th:href="@{/directors/{director}(director=${movie.director})}" th:text="${movie.director}"
				style="text-decoration: none;margin-left: 100px; color: #FF3131; font-family: 'wendy one'; font-size: 28px;"></a>
		</div>
		<hr style="border-top: 3px solid #fff; margin: 20px 0;">
		<div style=" display: flex; align-items: center;">
			<h1 style="font-family: 'Wendy One', sans-serif; margin-right: 100px;"> Actors</h1>
			<ul style="list-style-type: none; padding: 0; display: flex; flex-wrap: wrap;">
				<li th:each="actor : ${actors}" style="margin-right: 50px;">
					<a th:href="@{/actors/{actorId}(actorId=${actor.id})}" th:text="${actor.name}"
						style="text-decoration: none;color: #FF3131; font-family: 'Wendy One'; font-size: 28px;"></a>
				</li>
			</ul>
		</div>
		<hr style="border-top: 3px solid #fff; margin: 20px 0;">
		<div style=" display: flex; align-items: center;">
			<div style="width: 10px; height: 20px;  background-color: red;  margin-right: 10px;margin-bottom: 8px;">
			</div>
			<div style=" display: flex; align-items: center;">
				<h1 style="font-family: 'Wendy One', sans-serif;"> Rates and review</h1>
			</div>
		</div>
		<br>
		<br>
		<form th:action="@{/{movieId}/comments(movieId=${movie.id})}" method="post"
			style="padding: 10px; background-color: #D9D9D9; border: 1px solid black; border-radius: 5px; width: 100%;"
			onsubmit="return validateRating()">
			<input type="hidden" name="rating" id="ratingInput">
			<div class="row">
				<div class="col-lg-6">
					<h2 style="font-family: 'Wendy One', sans-serif;font-size: 18px; color: #000000;" required>Your
						rate: <span id="userStarRating">
							<span class="star" data-rating="1">★</span>
							<span class="star" data-rating="2">★</span>
							<span class="star" data-rating="3">★</span>
							<span class="star" data-rating="4">★</span>
							<span class="star" data-rating="5">★</span>
						</span> </h2>
				</div>
			</div>
			<input type="hidden" name="movieId" th:value="${movie.id}" />
			<textarea name="description"
				style="font-family: 'Wendy One', sans-serif;font-size: 18px; width: 100%; padding: 5px; background-color: #D9D9D9; border: none; border-radius: 5px; color: black"
				placeholder="Write your comment here" required></textarea>
			<button
				style="padding: 1px 2px;background-color: #FF3131;font-family: 'Wendy One', sans-serif; color: white; border-radius: 5px;"
				type="submit">Send </button>
		</form>

		<br>
		<h2 style="font-family: 'Wendy One', sans-serif;"><span th:text="${commentCount}"></span> comments </h2>
		<div class="content-container">
			<div th:each="comment : ${comments}" class="comment-container">
				<img th:src="${comment.avatar}" alt="Avatar" class="avatar">
				<div class="comment-details">
					<span th:text="${comment.username}" class="username"></span>
					<div class="rating">
						<span th:each="i : ${#numbers.sequence(1, comment.rate)}" class="star">★</span>
						<span th:each="i : ${#numbers.sequence(comment.rate + 1, 5)}" class="star-empty">☆</span>
					</div>
					<p th:text="${comment.description}" class="comment-text"></p>
				</div>
			</div>
		</div>
	</div>
</body>
<script>

	const stars = document.querySelectorAll('#userStarRating .star');
	let currentRating = 5;

	stars.forEach((star, index) => {
		star.addEventListener('click', () => {
			currentRating = index + 1;
		});

		star.addEventListener('mouseover', () => {
			highlightStars(index + 1);
		});

		star.addEventListener('mouseout', () => {
			highlightStars(currentRating);
		});
	});

	function highlightStars(rating) {
		stars.forEach((star, index) => {
			if (index < rating) {
				star.style.color = '#FF3131';
			} else {
				star.style.color = '#ffffff';
			}
		});
	}
	function validateRating() {
		const ratingInput = document.getElementById('ratingInput');
		if (ratingInput.value === "" || isNaN(ratingInput.value)) {
			alert("Please rate the movie before submitting.");
			return false;
		}
		return true;
	}

	const ratingInput = document.getElementById('ratingInput');
	const ratingStars = document.querySelectorAll('.star');

	ratingStars.forEach(star => {
		star.addEventListener('click', () => {
			const selectedRating = parseInt(star.dataset.rating, 10);
			ratingInput.value = selectedRating;
			ratingStars.forEach(s => {
				s.style.color = parseInt(s.dataset.rating, 10) <= selectedRating ? '#FF3131' : '#ffffff';
			});
		});
	});
	document.getElementById('addToFavoriteBtn').addEventListener('click', async function () {
		try {
			const loginResponse = await fetch('/favorites/check-login', {method: 'GET'});
			const isLoggedIn = await loginResponse.json();

			console.log('Login Response Status:', loginResponse.status);
			console.log('Is Logged In:', isLoggedIn);

			if (!isLoggedIn) {
				alert("Please login to add to favorites.");
				return;
			}

			const movieId = this.getAttribute('data-movie-id');
			console.log('Movie ID:', movieId);

			// Kiểm tra xem phim đã nằm trong danh sách yêu thích chưa
			const checkFavoriteResponse = await fetch(`/favorites/exists/${movieId}`, {method: 'GET'});
			const isFavorite = await checkFavoriteResponse.json();

			console.log('Is Favorite:', isFavorite);

			if (isFavorite) {
				alert("This movie is already in your favorites.");
				return;
			}

			// Thêm vào danh sách yêu thích
			const response = await fetch('/favorites/add', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({movie_id: movieId})
			});

			console.log('Add to Favorites Response Status:', response.status);

			if (response.ok) {
				alert("Movie added to favorites successfully.");
			} else if (response.status === 409) {
				alert("This movie is already in your favorites.");
			} else {
				alert("Failed to add movie to favorites.");
				const errorMessage = await response.text();
				console.error('Error Message:', errorMessage);
			}
		} catch (error) {
			console.error('Error:', error);
			alert("Please login to add to favorites");
		}
	});
</script>

</html>