<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{admin/fragments/head :: head}"></head>
<link type="text/css" rel="stylesheet" th:href="@{/assets/css/user.css}" />
<link type="text/css" rel="stylesheet" th:href="@{/assets/css/auth.css}" />
<link href='https://fonts.googleapis.com/css?family=Wendy One' rel='stylesheet'>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css">
<div th:replace="user/fragments/header-guest :: header-guest"></div>

<body style="background-color: #212121;">
	<form id="userForm" th:action="@{/user/save}" method="post">
			<div class="login-form">
				<p style="margin-top: 10px;font-size: 40px;">Change information</p>
				<div>
					<label for="username" style="font-size: 20px;">Username:</label>
					<input type="text" id="username" name="username" th:value="${user.username}">
				</div>
				<div>
					<label for="email"style="font-size: 20px;">Email:</label>
					<input type="email" id="email" name="email" th:value="${user.email}">
				</div>
				<div>
					<label for="avatar"style="font-size: 20px;">Avatar's url':</label>
					<input type="text" id="avatar" name="avatar" th:value="${user.avatar}">
				</div>
				<div>
				<label for="password" style="font-size: 20px;">Password:</label>
				<div class="password-container">
					<input type="password" id="password" name="password" th:value="${user.password}" data-initial-value="${user.password}">
					<i class="far fa-eye" id="togglePassword"></i>
				</div>
			</div>
				<button id="saveChangesButton" class="register-button" type="button">Save changes</button>
		</div>
	</form>

	<div id="otpForm" style="display: none;">
		<h2 style="color: white; font-family: 'Wendy One', sans-serif;">Enter OTP</h2>
		<div class="input-field">
			<input type="number" id="otp1" maxlength="1" />
			<input type="number" id="otp2" maxlength="1" disabled />
			<input type="number" id="otp3" maxlength="1" disabled />
			<input type="number" id="otp4" maxlength="1" disabled />
			<input type="number" id="otp5" maxlength="1" disabled />
			<input type="number" id="otp6" maxlength="1" disabled />
		</div>

		<button class="start-button" id="verifyButton" disabled>Verify OTP</button>

	</div>

	<script>
		const togglePassword = document.querySelector('#togglePassword');
		const passwordInput = document.querySelector('#password');

		togglePassword.addEventListener('click', function (e) {
			const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
			passwordInput.setAttribute('type', type);

			this.classList.toggle('fa-eye-slash');
			this.classList.toggle('fa-eye');
		});
		async function sendOtp(email) {
			const response = await fetch('/user/send-otp', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded'
				},
				body: new URLSearchParams({email: email})
			});
			return response.text();
		}

		async function verifyOtp(otp) {
			const response = await fetch('/user/verify-otp', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded'
				},
				body: new URLSearchParams({otp: otp})
			});
			return response.json();
		}

		document.getElementById('saveChangesButton').addEventListener('click', async function (e) {
			e.preventDefault();

			const email = document.getElementById('email').value;
			const password = document.getElementById('password').value;

			if (email === '' || password === '') {
				alert('Please fill in all required fields.');
				return;
			}

			const otp = await sendOtp(email);
			alert('OTP sent to your email.');

			// Hide profile form and show OTP form
			document.getElementById('userForm').style.display = 'none';
			document.getElementById('otpForm').style.display = 'block';

			// Save OTP temporarily
			window.generatedOtp = otp;
		});

		const inputs = document.querySelectorAll(".input-field input"),
			button = document.querySelector("#verifyButton");

		// iterate over all inputs
		inputs.forEach((input, index1) => {
			input.addEventListener("keyup", (e) => {
				const currentInput = input,
					nextInput = input.nextElementSibling,
					prevInput = input.previousElementSibling;

				if (currentInput.value.length > 1) {
					currentInput.value = "";
					return;
				}

				if (nextInput && nextInput.hasAttribute("disabled") && currentInput.value !== "") {
					nextInput.removeAttribute("disabled");
					nextInput.focus();
				}

				if (e.key === "Backspace") {
					inputs.forEach((input, index2) => {
						if (index1 <= index2 && prevInput) {
							input.setAttribute("disabled", true);
							input.value = "";
							prevInput.focus();
						}
					});
				}

				if (!inputs[5].disabled && inputs[5].value !== "") {
					button.classList.add("active");
					button.removeAttribute("disabled");
					return;
				}
				button.classList.remove("active");
				button.setAttribute("disabled", true);
			});
		});

		// focus the first input which index is 0 on window load
		window.addEventListener("load", () => inputs[0].focus());

		button.addEventListener("click", async () => {
			let enteredOtp = "";
			inputs.forEach(input => {
				enteredOtp += input.value;
			});

			if (await verifyOtp(enteredOtp)) {
				alert("OTP verified successfully!");

				// Xử lý lưu thông tin vào cơ sở dữ liệu
				const form = document.getElementById('userForm');
				const formData = new FormData(form);
				try {
					const response = await fetch(form.action, {
						method: form.method,
						body: formData
					});

					if (response.ok) {
						alert("Infomation saved successfully");
						window.location.reload();
					} else {
						alert("Error.");
					}
				} catch (error) {
					console.error("Error:", error);
					alert("Error.");
				}
			} else {
				alert("Invalid OTP. Please try again.");
			}
		});
	</script>
	<style>
		body {
			display: flex;
			align-items: center;
			justify-content: center;
			height: 100vh;
			background-color: #212121;
			font-family: 'Wendy One', sans-serif;
			color: white;
		}

		.input-field {
			display: flex;
			justify-content: center;
			gap: 10px;
			margin-bottom: 20px;
		}

		.input-field input {
			width: 50px;
			height: 50px;
			text-align: center;
			background-color: gray;
			color: white;
			border: none;
			font-size: 24px;
			font-family: 'Wendy One', sans-serif;
			overflow: hidden;
		}

		.start-button {
			padding: 10px 20px;
			background-color: #4CAF50;
			/* Màu nền của nút */
			border: none;
			color: white;
			font-size: 16px;
			font-family: 'Wendy One', sans-serif;
			cursor: not-allowed;
		}

		.start-button.active {
			cursor: pointer;
		}

		.start-button:disabled {
			opacity: 0.5;
		}

		h2 {
			margin-bottom: 20px;
		}

		input[type=number]::-webkit-inner-spin-button,
		input[type=number]::-webkit-outer-spin-button {
			-webkit-appearance: none;
			margin: 0;
		}

		input[type=number] {
			-moz-appearance: textfield;
			appearance: textfield;
		}
	</style>
</body>

</html>